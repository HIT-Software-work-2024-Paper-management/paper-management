<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paper Management System</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<h1>Paper Management System</h1>
<div id="app">
    <form id="paper-form">
        <h2>Upload Paper</h2>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" required>
        <label for="authors">Authors:</label>
        <div id="authors"></div>
        <button type="button" onclick="addAuthor()">Add Author</button>
        <!-- 其他字段 -->
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required>
        <label for="journal">Journal:</label>
        <select id="journal" name="journal" required></select>
        <label for="file">File:</label>
        <input type="file" id="file" name="file" required>
        <label for="categoryId">Category ID:</label>
        <input type="number" id="categoryId" name="categoryId" required readonly>
        <label for="type">Type:</label>
        <select id="type" name="type" required></select>
        <label for="impactFactor">Impact Factor:</label>
        <input type="number" step="0.01" id="impactFactor" name="impactFactor" required>
        <button type="submit">Upload</button>
    </form>
    <h2>View Papers</h2>
    <button id="view-papers-button">View Uploaded Papers</button>
    <ul id="paper-list"></ul>
</div>

<script>
    let authorsData = []; // 保存从后端获取的作者数据

    // 动态加载作者列表
    function loadAuthors() {
        fetch('/api/authors')
            .then(response => response.json())
            .then(data => {
                authorsData = data;
            })
            .catch(error => console.error('Error fetching authors:', error));
    }

    // 动态添加作者输入字段
    function addAuthor() {
        const authorDiv = document.createElement('div');
        authorDiv.classList.add('author');
        const authorSelect = document.createElement('select');
        authorSelect.name = 'authorId';
        authorSelect.required = true;

        authorsData.forEach(author => {
            const option = document.createElement('option');
            option.value = author.id;
            option.textContent = author.name;
            authorSelect.appendChild(option);
        });

        authorDiv.innerHTML = `
            <select name="authorRank" required>
                <option value="" disabled selected>Select Rank</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
            <button type="button" onclick="removeAuthor(this)">Remove</button>
        `;
        authorDiv.insertBefore(authorSelect, authorDiv.firstChild);
        document.getElementById('authors').appendChild(authorDiv);
    }

    // 移除作者输入字段
    function removeAuthor(button) {
        button.parentElement.remove();
    }

    // 将日期字符串格式化为 yyyy-MM-dd
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAuthors(); // 加载作者列表

        const form = document.getElementById('paper-form');
        const paperList = document.getElementById('paper-list');
        const viewPapersButton = document.getElementById('view-papers-button');
        const categorySelect = document.getElementById('type');
        const journalSelect = document.getElementById('journal');
        const categoryIdInput = document.getElementById('categoryId');

        // Fetch categories and populate the dropdown
        fetch('/api/categories/searchid')
            .then(response => response.json())
            .then(data => {
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name; // 使用类型名称作为值
                    option.textContent = category.name;
                    option.setAttribute('data-id', category.id); // 使用 data-* 属性存储 category.id
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching categories:', error));

        // Fetch journals and populate the dropdown
        fetch('/api/journals')
            .then(response => response.json())
            .then(data => {
                data.forEach(journal => {
                    const option = document.createElement('option');
                    option.value = journal.id;
                    option.textContent = journal.name;
                    journalSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching journals:', error));

        // Update categoryId when category is selected
        categorySelect.addEventListener('change', () => {
            const selectedCategory = categorySelect.options[categorySelect.selectedIndex];
            categoryIdInput.value = selectedCategory.getAttribute('data-id'); // 从 data-id 属性获取 category.id
        });

        // Fetch and display all papers when "View Uploaded Papers" button is clicked
        viewPapersButton.addEventListener('click', () => {
            paperList.innerHTML = ''; // Clear the current list
            fetchPapers();
        });

        function fetchPapers() {
            fetch('/api/papers')
                .then(response => response.json())
                .then(data => {
                    data.forEach(paper => {
                        const listItem = createPaperListItem(paper);
                        paperList.appendChild(listItem);
                    });
                })
                .catch(error => console.error('Error fetching papers:', error));
        }

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(form);

            // 将作者信息以列表形式添加到 FormData
            const authors = document.querySelectorAll('.author');
            authors.forEach((author, index) => {
                formData.append(`authors[${index}].id`, author.querySelector('select[name="authorId"]').value);
                formData.append(`authors[${index}].rank`, author.querySelector('select[name="authorRank"]').value);
            });

            fetch('/api/papers/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const listItem = createPaperListItem(data);
                paperList.appendChild(listItem);
                form.reset();
                alert('Paper uploaded successfully!');
            })
            .catch(error => console.error('Error uploading paper:', error));
        });

        paperList.addEventListener('click', (event) => {
            const listItem = event.target.parentElement;
            const paperId = listItem.getAttribute('data-id');

            if (event.target.classList.contains('view')) {
                fetch(`/api/papers/${paperId}`)
                    .then(response => response.json())
                    .then(paper => {
                        document.getElementById('title').value = paper.title;
                        document.getElementById('date').value = formatDate(paper.date);
                        document.getElementById('journal').value = paper.journal.id;
                        document.getElementById('categoryId').value = paper.category.id;
                        document.getElementById('type').value = paper.type;
                        document.getElementById('impactFactor').value = paper.impactFactor;

                        const authorsContainer = document.getElementById('authors');
                        authorsContainer.innerHTML = '';
                        paper.authors.forEach((author, index) => {
                            const authorDiv = document.createElement('div');
                            authorDiv.classList.add('author');
                            const authorSelect = document.createElement('select');
                            authorSelect.name = 'authorId';
                            authorSelect.required = true;

                            authorsData.forEach(auth => {
                                const option = document.createElement('option');
                                option.value = auth.id;
                                option.textContent = auth.name;
                                if (auth.id === author.id) {
                                    option.selected = true;
                                }
                                authorSelect.appendChild(option);
                            });

                            authorDiv.innerHTML = `
                                <select name="authorRank" required>
                                    <option value="1" ${author.rank == 1 ? 'selected' : ''}>1</option>
                                    <option value="2" ${author.rank == 2 ? 'selected' : ''}>2</option>
                                    <option value="3" ${author.rank == 3 ? 'selected' : ''}>3</option>
                                </select>
                                <button type="button" onclick="removeAuthor(this)">Remove</button>
                            `;
                            authorDiv.insertBefore(authorSelect, authorDiv.firstChild);
                            authorsContainer.appendChild(authorDiv);
                        });
                    })
                    .catch(error => console.error('Error fetching paper:', error));
            }

if (event.target.classList.contains('edit')) {
    const formData = new FormData(form);
    formData.set('title', document.getElementById('title').value);
    formData.append('date', formData.get('date'));
    formData.append('journal', formData.get('journal'));
    formData.append('file', listItem.querySelector('.download').getAttribute('data-file-url'));
    formData.append('categoryId', formData.get('categoryId'));
    formData.set('type', document.getElementById('type').value);
    formData.append('impactFactor', formData.get('impactFactor'));

    // Adding authors to formData
    const authorElements = document.querySelectorAll('.author');
    authorElements.forEach((authorElement, index) => {
        formData.append(`authorsMap[${index}].id`, authorElement.querySelector('select[name="authorId"]').value);
        formData.append(`authorsMap[${index}].rank`, authorElement.querySelector('select[name="authorRank"]').value);
    });

    fetch(`/api/papers/${paperId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => console.log('Success:', data))
    .catch(error => console.error('Error:', error));
}

            if (event.target.classList.contains('delete')) {
                fetch(`/api/papers/${paperId}`, {
                    method: 'DELETE'
                })
                .then(() => {
                    listItem.remove();
                })
                .catch(error => console.error('Error deleting paper:', error));
            }

            if (event.target.classList.contains('download')) {
                const fileUrl = `/api/papers/${paperId}/download`;
                window.open(fileUrl, '_blank');
            }
        });

        function createPaperListItem(paper) {
            const listItem = document.createElement('li');
            listItem.setAttribute('data-id', paper.id);

            const authors = paper.authors || [];
            const title = paper.title || 'Unknown Title';
            const date = formatDate(paper.date) || 'Unknown Date';
            const journal = paper.journal || {};
            const journalId = journal.id || 'Unknown Journal ID';
            const journalName = journal.name || 'Unknown Journal';
            const category = paper.category || {};
            const categoryName = category.name || 'Unknown Category';
            const type = paper.type || 'Unknown Type';
            const impactFactor = paper.impactFactor || 'Unknown Impact Factor';
            const fileUrl = paper.fileUrl || '#';

            listItem.innerHTML = `
                <span>Title: ${title}</span>,
                <span>Authors: ${authors.map(author => `${author.name}:${author.rank}`).join('; ')}</span>,
                <span>Date: ${date}</span>,
                <span data-id="${journalId}">Journal: ${journalName}</span>,
                <span>Category: ${categoryName}</span>,
                <span>Type: ${type}</span>,
                <span>Impact Factor: ${impactFactor}</span>,
                <button class="view">View</button>
                <button class="edit">Edit</button>
                <button class="delete">Delete</button>
                <button class="download" data-file-url="${fileUrl}">Download</button>
            `;
            return listItem;
        }
    });
</script>

</body>
</html>
